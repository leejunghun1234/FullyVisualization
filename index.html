<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fully Visualization</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/png" href="./ÌïòÎßà4.png">
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three/examples/jsm/",
                "chart.js": "https://cdn.jsdelivr.net/npm/chart.js/+esm"
            }
        }
    </script>
</head>
<body oncontextmenu = "return false" ondragstart = "return false" ondragend = "return false">
    <div>
        <div id="root">
            <div id="render-target"></div>

            <div id="right-panel">
                <div id="cat-buttons">
                    <button id="quant-button" class="cat-button">Quant Num</button>
                    <button id="chart-button" class="cat-button">Quant chart</button>
                    <button id="info-button" class="cat-button">Element Info</button>
                </div>
                <div class="cat-divs"  id="info-divs">
                    <div class="info-target" id="info-target"></div>
                </div>

                <div class = "cat-divs hide" id = "chart-divs">
                    <div class = "info-target" id = "info-target">
                        <div class = "graph-values">
                            <h2 class = "graph-name">Walls</h2>
                            <canvas class = "graph-cat" id = "graph-wall"></canvas>
                            <div class = "gapgap">
                                <div class = "gapa">ñ§Ç</div>
                            </div>
                        </div>
                        <div class = "graph-values">
                            <h2 class = "graph-name">Curtain Wall</h2>
                            <canvas class = "graph-cat" id = "graph-curtainWall"></canvas>
                            <div class = "gapgap">
                                <div class = "gapa">ñ§Ç</div>
                            </div>
                        </div>
                        <div class = "graph-values">
                            <h2 class = "graph-name">Floor</h2>
                            <canvas class = "graph-cat" id = "graph-floor"></canvas>
                            <div class = "gapgap">
                                <div class = "gapa">ñ§Ç</div>
                            </div>
                        </div>
                        <div class = "graph-values">
                            <h2 class = "graph-name">Ceiling</h2>
                            <canvas class = "graph-cat" id = "graph-ceiling"></canvas>
                            <div class = "gapgap">
                                <div class = "gapa">ñ§Ç</div>
                            </div>
                        </div>
                        <div class = "graph-values">
                            <h2 class = "graph-name">Column</h2>
                            <canvas class = "graph-cat" id = "graph-column"></canvas>
                            <div class = "gapgap">
                                <div class = "gapa">ñ§Ç</div>
                            </div>
                        </div>
                        <div class = "graph-values">
                            <h2 class = "graph-name">Structural Column</h2>
                            <canvas class = "graph-cat" id = "graph-structuralColumn"></canvas>
                            <div class = "gapgap">
                                <div class = "gapa">ñ§Ç</div>
                            </div>
                        </div>
                        <div class = "graph-values">
                            <h2 class = "graph-name">Stair</h2>
                            <canvas class = "graph-cat" id = "graph-stair"></canvas>
                            <div class = "gapgap">
                                <div class = "gapa">ñ§Ç</div>
                            </div>
                        </div>
                        <div class = "graph-values">
                            <h2 class = "graph-name">Railing</h2>
                            <canvas class = "graph-cat" id = "graph-railing"></canvas>
                            <div class = "gapgap">
                                <div class = "gapa">ñ§Ç</div>
                            </div>
                        </div>
                        <div class = "graph-values">
                            <h2 class = "graph-name">Windows</h2>
                            <canvas class = "graph-cat" id = "graph-forwindow"></canvas>
                            <div class = "gapgap">
                                <div class = "gapa">ñ§Ç</div>
                            </div>
                        </div>
                        <div class = "graph-values">
                            <h2 class = "graph-name">Doors</h2>
                            <canvas class = "graph-cat" id = "graph-door"></canvas>
                            <div class = "gapgap">
                                <div class = "gapa">ñ§Ç</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class= "cat-divs hide" id="element-divs">
                    <div class="info-target" id="element-target"></div>
                </div>

                <div id="busan-panel">
                    <button class="busan-button" id="import-button">Input Folder</button>
                    <button class="busan-button">Full Screen</button>
                    <button class="busan-button">Full Screen</button>
                    <button class="busan-button">Full Screen</button>
                </div>
            </div>

            <div id="down-panel">
                <div id="slider-target">
                    <button id="decrease-1" class="inorde"><</button>
                    <input type="range" id="fully-slider" class="slider">
                    <button id="increase-1" class="inorde">></button>
                    <button id="time-button">TIME</button>
                </div>
                <div id="slider-buttons">
                    <button id="rewind"><</button>
                    <button id="pause">II</button>
                    <button id="play">></button>
                    <button id="fast-forward">>></button>
                </div>
            </div>

            
        </div>

        
<!-- 
        <div>
            <button id="import-button"></button>
        </div> -->
    </div>
    
    <div class="modal-overlay" id="modalOverlay"></div>
    <div class="modal" id="dateTimeModal">
        <div class="modal-content">
            <h3 id = "modal-head">ÎÇ†Ïßú & ÏãúÍ∞Ñ ÏÑ†ÌÉù</h3>
            <div id = "input-container">
                <input type="date" id="dateInput">
                <input type="time" id="timeInput">
            </div>
            
            <div id = "close-container">
                <button id = "okay-button" class="f close-btn">ÌôïÏù∏</button>
                <button id = "cancel-button" class="f close-btn">Ï∑®ÏÜå</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { main } from './main.js';

        // Î≤ÑÌäº ÎàÑÎ•¥Î©¥ ÏÉàÎ°úÍ≥†Ïπ®Ìï¥ÏÑú Îã§ Ï¥àÍ∏∞Ìôî ÌïúÎ≤à ÏãúÌÇ§Í≥† -> Ìè¥Îçî ÏÑ†ÌÉùÌï¥ÏÑú Î∂àÎü¨Ïò§Í∏∞
        const inputButton = document.getElementById("import-button");
        let shapeLog, timeLog;
        let wallQ, ctWallQ, floorQ, ceilingQ, columnQ, stColumnQ, stairQ, railingQ, windowQ, doorQ;

        const csvTargets = {
            "Walls_test": "wallQ",
            "Curtain Walls_test": "ctWallQ",
            "Floors_test": "floorQ",
            "Ceilings_test": "ceilingQ",
            "Columns_test": "columnQ",
            "Structural Columns_test": "stColumnQ",
            "Stairs_test": "stairQ",
            "Railings_test": "railingQ",
            "Windows_test": "windowQ",
            "Doors_test": "doorQ"
        };


        inputButton.addEventListener('click', async () => {
            try {
                localStorage.setItem("reloadPending", "true");

                const dirHandle = await window.showDirectoryPicker();
                for await (const [name, handle] of dirHandle.entries()) {
                    if (handle.kind !== 'file') continue;

                    const file = await handle.getFile();

                    // JSON Ï≤òÎ¶¨
                    if (name.endsWith('.json')) {
                        try {
                            const json = await LoadJson(file);
                            if (name.includes("shapeLogs")) shapeLog = json;
                            if (name.includes("timeLogs")) timeLog = json;
                        } catch (err) {
                            console.error(`JSON ÌååÏã± Ïã§Ìå®: ${name}`);
                        }
                    }

                    // CSV Ï≤òÎ¶¨
                    if (handle.kind === 'file' && name.endsWith('.csv')) {
                        const file = await handle.getFile();
                        if (name.includes("Walls_test")) {
                            wallQ = await LoadCSV(file);
                        }
                        if (name.includes("Curtain Walls_test")) {
                            ctWallQ = await LoadCSV(file);
                        }
                        if (name.includes("Floors_test")) {
                            floorQ = await LoadCSV(file);
                        }
                        if (name.includes("Ceilings_test")) {
                            ceilingQ = await LoadCSV(file);
                        }
                        if (name.includes("Columns_test")) {
                            columnQ = await LoadCSV(file);
                        }
                        if (name.includes("Structural Columns_test")) {
                            stColumnQ = await LoadCSV(file);
                        }
                        if (name.includes("Stairs_test")) {
                            stairQ = await LoadCSV(file);
                        }
                        if (name.includes("Railings_test")) {
                            railingQ = await LoadCSV(file);
                        }
                        if (name.includes("Windows_test")) {
                            windowQ = await LoadCSV(file);
                        }
                        if (name.includes("Doors_test")) {
                            doorQ = await LoadCSV(file);
                        }
                    }
                }
                console.log(wallQ);
                main(shapeLog, timeLog, wallQ, ctWallQ, floorQ, ceilingQ, columnQ, stColumnQ, stairQ, railingQ, windowQ, doorQ);
            } catch (err) {
                console.error(err);
            }
        });

        window.addEventListener("load", async () => {
            if (localStorage.getItem("reloadPending") === "true") {
                localStorage.removeItem("reloadPending");

                // JSON Î°úÎî©
                shapeLog = JSON.parse(localStorage.getItem("shapeLog"));
                timeLog = JSON.parse(localStorage.getItem("timeLog"));

                // CSV Ìï≠Î™© Î°úÎî© ÎåÄÏÉÅ Î™©Î°ù
                const csvKeys = [
                    "wallQ", "ctWallQ", "floorQ", "ceilingQ",
                    "columnQ", "stColumnQ", "stairQ", "railingQ",
                    "windowQ", "doorQ"
                ];

                for (const key of csvKeys) {
                    const data = localStorage.getItem(key);
                    if (data) {
                        window[key] = JSON.parse(data);
                    }
                }

                // ÏÇ¨Ïö© ÌõÑ localStorage Ï†ïÎ¶¨
                localStorage.removeItem("shapeLog");
                localStorage.removeItem("timeLog");
                for (const key of csvKeys) {
                    localStorage.removeItem(key);
                }

                // main Ìï®Ïàò Ìò∏Ï∂ú (ÌïÑÏöîÌïú Îç∞Ïù¥ÌÑ∞Î•º ÎÑ£Ïñ¥Ï£ºÏÑ∏Ïöî)
                  // ÌïÑÏöîÌïú Í≤ΩÏö∞ Îã§Î•∏ QÎèÑ Ï†ÑÎã¨
            }
        });

        async function LoadJson(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();

                reader.onload = (event) => {
                    try {
                        const json = JSON.parse(event.target.result);
                        resolve(json);
                    } catch (error) {
                        reject(`‚ùå JSON ÌååÏã± Ïã§Ìå®: ${file.name}`);
                    }
                };

                reader.onerror = () => {
                    reject(`‚ùå ÌååÏùº ÏùΩÍ∏∞ Ïã§Ìå®: ${file.name}`);
                };

                reader.readAsText(file);
            });
        }
    
        async function LoadCSV(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();

                reader.onload = (event) => {
                    try {
                        const text = event.target.result;

                        const rows = text
                            .trim()
                            .split("\n")
                            .map(row => row.split(",").map(cell => cell.trim()));

                        resolve(rows);
                    } catch (error) {
                        reject(`‚ùå CSV ÌååÏã± Ïã§Ìå®: ${file.name}`);
                    }
                };

                reader.onerror = () => {
                    reject(`‚ùå ÌååÏùº ÏùΩÍ∏∞ Ïã§Ìå®: ${file.name}`);
                };

                reader.readAsText(file);
            });
        }
    </script>
</body>
</html>